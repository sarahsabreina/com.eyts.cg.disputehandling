<mvc:View
    controllerName="project2.controller.View2"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    xmlns:f="sap.f"
    displayBlock="true"
    height="100%">

    <f:DynamicPage
        id="dynamicPageId"
        fitContent="false"
        toggleHeaderOnTitleClick="false">

<!-- ===================================== -->
<!-- PAGE TITLE -->
<!-- ===================================== -->
<f:title>
    <f:DynamicPageTitle id="dpTitle">
        <f:heading>
            <Title id="pageTitle" text="Dispute Queue"/>
        </f:heading>

        <!-- snapped KPI counters (with Last Sync) -->
        <f:snappedContent>
            <FlexBox id="_IDGenFlexBox1" alignItems="Center" justifyContent="SpaceBetween" width="100%">
                <FlexBox id="_IDGenFlexBox2" alignItems="Center">
                    <ObjectNumber
                        id="snapNew"
                        number="{viewModel>/counts/new}"
                        unit="New"
                        state="Warning"
                        class="sapUiTinyMarginEnd"/>

                    <ObjectNumber
                        id="snapMine"
                        number="{viewModel>/counts/mine}"
                        unit="My Queue"
                        state="Information"
                        class="sapUiTinyMarginEnd"/>

                    <ObjectNumber
                        id="snapOverdue"
                        number="{viewModel>/counts/overdue}"
                        unit="Overdue"
                        state="Error"/>
                </FlexBox>
                
                <!-- Last Sync Info in Snapped Header -->
                <HBox id="syncInfoSnapped" alignItems="Center">
                    <Label id="syncFromLabel" text="From:" class="sapUiTinyMarginEnd"/>
                    <Text id="syncFromDate" text="{viewModel>/filterDateFrom}" class="sapUiSmallMarginEnd"/>
                    
                    <Label id="syncTimeLabel" text="Last sync:" class="sapUiTinyMarginEnd"/>
                    <Text id="syncTimeText" text="{viewModel>/lastSyncTime}"/>
                    
                    <Button id="syncMoreBtn" 
                        icon="sap-icon://overflow" 
                        type="Transparent"
                        press="onToggleHeader"/>
                </HBox>
            </FlexBox>
        </f:snappedContent>

        <f:actions>
            <Button
                id="btnFilter"
                text="Filter"
                icon="sap-icon://filter"
                press="onFilterPress"/>

            <Button
                id="btnExport"
                text="Export"
                icon="sap-icon://excel-attachment"
                press="onExport"/>

            <SegmentedButton
                id="viewModeSwitch"
                selectedKey="{viewModel>/viewMode}"
                selectionChange="onToggleViewMode">
                <items>
                    <SegmentedButtonItem id="_IDGenSegmentedButtonItem" key="table" icon="sap-icon://table-view"/>
                    <SegmentedButtonItem id="_IDGenSegmentedButtonItem1" key="kanban" icon="sap-icon://column-chart-dual-axis"/>
                </items>
            </SegmentedButton>
        </f:actions>
    </f:DynamicPageTitle>
</f:title>

        <!-- ===================================== -->
        <!-- PAGE HEADER (KPI + FILTERS) -->
        <!-- ===================================== -->
        <f:header>
            <f:DynamicPageHeader id="dpHeader" pinnable="true">
                <VBox id="_IDGenVBox" width="100%">

                    <!-- KPI Cards Row -->
                    <FlexBox id="kpiRow" wrap="Wrap" fitContainer="true" class="sapUiSmallMarginBottom">
                        <l:VerticalLayout id="_IDGenVerticalLayout" class="sapUiSmallMarginEnd">
                            <ObjectNumber id="_IDGenObjectNumber"
                                number="{viewModel>/counts/new}"
                                emphasized="true"
                                state="Warning"
                                unit="New Cases"/>
                            <Text id="_IDGenText" text="Last 24 hours" class="sapUiTinyMarginTop"/>
                        </l:VerticalLayout>

                        <l:VerticalLayout id="_IDGenVerticalLayout1" class="sapUiSmallMarginEnd">
                            <ObjectNumber id="_IDGenObjectNumber1"
                                number="{viewModel>/counts/overdue}"
                                emphasized="true"
                                state="Error"
                                unit="Overdue"/>
                            <Text id="_IDGenText1" text="SLA Breached" class="sapUiTinyMarginTop"/>
                        </l:VerticalLayout>

                        <l:VerticalLayout id="_IDGenVerticalLayout2" class="sapUiSmallMarginEnd">
                            <ObjectNumber id="_IDGenObjectNumber2"
                                number="{viewModel>/counts/mine}"
                                emphasized="true"
                                state="Information"
                                unit="Assigned to Me"/>
                            <Text id="_IDGenText2" text="Active cases" class="sapUiTinyMarginTop"/>
                        </l:VerticalLayout>

                        <l:VerticalLayout id="_IDGenVerticalLayout3">
                            <ObjectNumber id="_IDGenObjectNumber3"
                                number="{viewModel>/counts/all}"
                                emphasized="true"
                                unit="Total Open"/>
                            <Text id="_IDGenText3" text="All statuses" class="sapUiTinyMarginTop"/>
                        </l:VerticalLayout>
                    </FlexBox>

                    <!-- Filter / Actions Row -->
<OverflowToolbar id="filterToolbar">
    <ToolbarSpacer id="_IDGenToolbarSpacer"/>

    <Label id="_IDGenLabel" text="From:" class="sapUiTinyMarginEnd"/>
    <DatePicker
        id="dateFrom"
        value="{viewModel>/filterDateFrom}"
        valueFormat="yyyy-MM-dd"
        displayFormat="dd/MM/yyyy"
        change="onDateChange"
        class="sapUiSmallMarginEnd"/>

    <Label id="_IDGenLabel1" text="To:" class="sapUiTinyMarginEnd"/>
    <DatePicker
        id="dateTo"
        value="{viewModel>/filterDateTo}"
        valueFormat="yyyy-MM-dd"
        displayFormat="dd/MM/yyyy"
        change="onDateChange"
        class="sapUiSmallMarginEnd"/>

    <SegmentedButton
        id="quickDateFilter"
        selectedKey="{viewModel>/selectedDateRange}"
        selectionChange="onQuickDateFilter"
        class="sapUiSmallMarginEnd">
        <items>
            <SegmentedButtonItem id="filterToday" key="today" text="Today"/>
            <SegmentedButtonItem id="filterWeek" key="week" text="This Week"/>
            <SegmentedButtonItem id="filterMonth" key="month" text="This Month"/>
            <SegmentedButtonItem id="filterCustom" key="custom" text="Custom"/>
        </items>
    </SegmentedButton>

    <Button
        id="refreshButton"
        icon="sap-icon://refresh"
        text="Refresh"
        type="Emphasized"
        press="onRefreshData"
        class="sapUiSmallMarginEnd"/>

    <Switch
        id="autoRefreshSwitch"
        state="{viewModel>/autoRefresh}"
        customTextOn="Auto"
        customTextOff="Manual"
        change="onAutoRefreshToggle"
        class="sapUiSmallMarginEnd"/>

    <Text id="lastSyncText" text="Last sync: {viewModel>/lastSyncTime}"/>
</OverflowToolbar>

                </VBox>
            </f:DynamicPageHeader>
        </f:header>

        <!-- ===================================== -->
        <!-- PAGE CONTENT -->
        <!-- ===================================== -->
        <f:content>

            <IconTabBar
                id="queueTabs"
                select="onTabSelect"
                selectedKey="{viewModel>/selectedTab}"
                class="sapUiNoContentPadding">

                <items>
                    <IconTabFilter id="_IDGenIconTabFilter"
                        key="new"
                        text="New/Updated"
                        count="{viewModel>/counts/new}"
                        icon="sap-icon://notification"/>

                    <IconTabFilter id="_IDGenIconTabFilter1"
                        key="mine"
                        text="My Queue"
                        count="{viewModel>/counts/mine}"
                        icon="sap-icon://person-placeholder"/>

                    <IconTabFilter id="_IDGenIconTabFilter2"
                        key="overdue"
                        text="Overdue"
                        count="{viewModel>/counts/overdue}"
                        icon="sap-icon://alert"/>

                    <IconTabFilter id="_IDGenIconTabFilter3"
                        key="all"
                        text="All Open"
                        count="{viewModel>/counts/all}"
                        icon="sap-icon://list"/>
                </items>

                <content>

                    <!-- ===================== -->
                    <!-- TABLE VIEW -->
                    <!-- ===================== -->
                    <Table
                        id="caseList"
                        class="casesTable"
                        width="100%"
                        fixedLayout="false"
                        items="{
                            path: '/DisputeCases',
                            parameters: {
                                expand: 'discrepancy,submitter,assignee,modifiedBy'
                            },
                            sorter: {
                                path: 'priority',
                                descending: true
                            }
                        }"
                        mode="MultiSelect"
                        selectionChange="onSelectionChange"
                        itemPress="onCasePress"
                        growing="true"
                        growingScrollToLoad="true"
                        sticky="ColumnHeaders"
                        visible="{= ${viewModel>/viewMode} === 'table' }">

                        <headerToolbar>
                            <OverflowToolbar id="_IDGenOverflowToolbar">
                                <Title id="_IDGenTitle" text="Cases" level="H2"/>
                                <ToolbarSpacer id="_IDGenToolbarSpacer1"/>

                                <SearchField id="_IDGenSearchField"
                                    width="380px"
                                    placeholder="Search by Case ID, Description, Reference..."
                                    search="onSearch"
                                    liveChange="onSearch"/>

                                <OverflowToolbarButton id="_IDGenOverflowToolbarButton"
                                    icon="sap-icon://group"
                                    text="Bulk Assign"
                                    press="onBulkAssign"
                                    enabled="{= ${viewModel>/selectedItems} > 0 }"/>

                                <OverflowToolbarButton id="_IDGenOverflowToolbarButton1"
                                    icon="sap-icon://sort"
                                    text="Sort"
                                    press="onSort"/>

                                <OverflowToolbarButton id="_IDGenOverflowToolbarButton2"
                                    icon="sap-icon://action-settings"
                                    text="Settings"
                                    press="onSettings"/>
                                    
                            </OverflowToolbar>
                        </headerToolbar>

                        <columns>
                            <Column id="_IDGenColumn" width="8rem">
                                <Text id="_IDGenText4" text="Case ID"/>
                            </Column>

                            <Column id="_IDGenColumn1" width="12rem" minScreenWidth="Tablet" demandPopin="true">
                                <Text id="_IDGenText5" text="Type"/>
                            </Column>

                            <Column id="_IDGenColumn2" width="8rem" hAlign="End">
                                <Text id="_IDGenText6" text="Variance"/>
                            </Column>

                            <Column id="_IDGenColumn3" width="8rem">
                                <Text id="_IDGenText7" text="Status"/>
                            </Column>

                            <Column id="_IDGenColumn4" width="8rem">
                                <Text id="_IDGenText8" text="Priority"/>
                            </Column>

                            <Column id="_IDGenColumn5" width="12rem" minScreenWidth="Tablet" demandPopin="true">
                                <Text id="_IDGenText9" text="Assigned To"/>
                            </Column>

                            <Column id="_IDGenColumn6" width="12rem" minScreenWidth="Tablet" demandPopin="true">
                                <Text id="_IDGenText10" text="Last Activity"/>
                            </Column>

                            <Column id="_IDGenColumn7" width="10rem">
                                <Text id="_IDGenText11" text="SLA"/>
                            </Column>

                            <Column id="_IDGenColumn8" width="8rem">
                                <Text id="_IDGenText12" text="Actions"/>
                            </Column>
                        </columns>

                        <items>
                            <ColumnListItem id="_IDGenColumnListItem" type="Navigation" press="onCasePress">
                                <cells>

                                    <!-- Case ID -->
                                    <ObjectIdentifier id="_IDGenObjectIdentifier"
                                        title="{caseID}"
                                        text="{discrepancy/discrepancyID}"
                                        titleActive="false"/>

                                    <!-- Type (single-line + tooltip prevents row height jumping) -->
                                    <VBox id="_IDGenVBox1">
                                        <Text id="_IDGenText13" text="{category}" wrapping="false" maxLines="1" tooltip="{category}"/>
                                        <Text id="_IDGenText14"
                                            text="{ path: 'isRecurring', formatter: '.formatter.formatRecurring' }"
                                            wrapping="false"
                                            maxLines="1"
                                            tooltip="{ path: 'isRecurring', formatter: '.formatter.formatRecurring' }"/>
                                    </VBox>

                                    <!-- Variance -->
                                    <ObjectNumber id="_IDGenObjectNumber4"
                                        number="{
                                            path: 'impactVariance',
                                            type: 'sap.ui.model.type.Currency',
                                            formatOptions: { showMeasure: false }
                                        }"
                                        unit="MYR"
                                        state="{ path: 'impactVariance', formatter: '.formatter.VarianceState' }"/>

                                    <!-- Status -->
                                    <ObjectStatus id="_IDGenObjectStatus"
                                        text="{status}"
                                        state="{ path: 'status', formatter: '.formatter.statusState' }"/>

                                    <!-- Priority -->
                                    <ObjectStatus id="_IDGenObjectStatus1"
                                        text="{priority}"
                                        state="{ path: 'priority', formatter: '.formatter.priorityState' }"
                                        icon="{ path: 'priority', formatter: '.formatter.priorityIcon' }"/>

                                    <!-- Assigned To (single line + ellipsis) -->
                                    <VBox id="_IDGenVBox2">
                                        <Text id="_IDGenText15"
                                            text="{assignee/firstName} {assignee/lastName}"
                                            wrapping="false"
                                            maxLines="1"
                                            tooltip="{assignee/firstName} {assignee/lastName}"/>
                                        <Text id="_IDGenText16"
                                            text="{assignee/workload} active cases"
                                            wrapping="false"
                                            maxLines="1"
                                            tooltip="{assignee/workload} active cases"/>
                                    </VBox>

                                    <!-- Last Activity (single line + ellipsis) -->
                                    <VBox id="_IDGenVBox3">
                                        <Text id="_IDGenText17"
                                            text="{ path: 'modifiedAt', formatter: '.formatter.formatRelativeDate' }"
                                            wrapping="false"
                                            maxLines="1"
                                            tooltip="{ path: 'modifiedAt', formatter: '.formatter.formatRelativeDate' }"/>
                                        <Text id="_IDGenText18"
                                            text="by {modifiedBy/firstName} {modifiedBy/lastName}"
                                            wrapping="false"
                                            maxLines="1"
                                            tooltip="by {modifiedBy/firstName} {modifiedBy/lastName}"/>
                                    </VBox>

                                    <!-- SLA -->
                                    <VBox id="_IDGenVBox4">
                                        <ObjectStatus id="_IDGenObjectStatus2"
                                            text="{slaRemainingHours}h left"
                                            state="{ path: 'slaStatus', formatter: '.formatter.slaState' }"/>
                                        <ProgressIndicator id="_IDGenProgressIndicator"
                                            percentValue="{ path: 'slaRemainingHours', formatter: '.formatter.slaPercentage' }"
                                            displayValue=""
                                            state="{ path: 'slaStatus', formatter: '.formatter.slaState' }"/>
                                    </VBox>

                                    <!-- Actions -->
                                    <HBox id="_IDGenHBox">
                                        <Button id="_IDGenButton1" icon="sap-icon://menu" type="Transparent" press="onShowActions"/>
                                    </HBox>

                                </cells>
                            </ColumnListItem>
                        </items>
                    </Table>

                    <!-- ===================== -->
                    <!-- KANBAN VIEW -->
                    <!-- ===================== -->
                    <ScrollContainer
                        id="kanbanView"
                        horizontal="true"
                        vertical="false"
                        height="100%"
                        visible="{= ${viewModel>/viewMode} === 'kanban' }"
                        class="sapUiSmallMargin">

                        <HBox id="_IDGenHBox1" class="kanbanBoard">

                            <!-- Submitted -->
                            <VBox id="_IDGenVBox5" class="kanbanColumn sapUiSmallMarginEnd">
                                <Toolbar id="_IDGenToolbar">
                                    <Title id="_IDGenTitle1" text="New/Submitted" level="H3"/>
                                    <ToolbarSpacer id="_IDGenToolbarSpacer2"/>
                                    <Label id="_IDGenLabel2" text="{viewModel>/kanban/submitted}"/>
                                </Toolbar>

                                <List id="_IDGenList"
                                    items="{
                                        path: '/DisputeCases',
                                        filters: [{
                                            path: 'status',
                                            operator: 'EQ',
                                            value1: 'SUBMITTED'
                                        }]
                                    }">

                                    <CustomListItem id="_IDGenCustomListItem" press="onCasePress">
                                        <VBox id="_IDGenVBox6" class="kanbanCard">
                                            <HBox id="_IDGenHBox2" justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                                <Text id="_IDGenText19" text="{caseID}" class="sapUiTinyMarginEnd"/>
                                                <core:Icon id="_IDGenIcon"
                                                    src="{ path: 'priority', formatter: '.formatter.priorityIcon' }"
                                                    color="{ path: 'priority', formatter: '.formatter.priorityColor' }"/>
                                            </HBox>
                                            <Text id="_IDGenText20" text="{category}" class="sapUiTinyMarginBottom" wrapping="false" maxLines="1" tooltip="{category}"/>
                                            <ObjectNumber id="_IDGenObjectNumber5" number="{impactAmount}" class="sapUiTinyMarginBottom"/>
                                            <HBox id="_IDGenHBox3" justifyContent="SpaceBetween">
                                                <Text id="_IDGenText21" text="{slaRemainingHours}h left"/>
                                                <Text id="_IDGenText22" text="{assignee/firstName}" wrapping="false" maxLines="1" tooltip="{assignee/firstName}"/>
                                            </HBox>
                                        </VBox>
                                    </CustomListItem>

                                </List>
                            </VBox>

                            <!-- In Review -->
                            <VBox id="_IDGenVBox7" class="kanbanColumn sapUiSmallMarginEnd">
                                <Toolbar id="_IDGenToolbar1">
                                    <Title id="_IDGenTitle2" text="In Review" level="H3"/>
                                    <ToolbarSpacer id="_IDGenToolbarSpacer3"/>
                                    <Label id="_IDGenLabel3" text="{viewModel>/kanban/inReview}"/>
                                </Toolbar>

                                <List id="_IDGenList1"
                                    items="{
                                        path: '/DisputeCases',
                                        filters: [{
                                            path: 'status',
                                            operator: 'EQ',
                                            value1: 'IN_REVIEW'
                                        }]
                                    }">

                                    <CustomListItem id="_IDGenCustomListItem1" press="onCasePress">
                                        <VBox id="_IDGenVBox8" class="kanbanCard">
                                            <HBox id="_IDGenHBox4" justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                                <Text id="_IDGenText23" text="{caseID}"/>
                                                <core:Icon id="_IDGenIcon1"
                                                    src="{ path: 'priority', formatter: '.formatter.priorityIcon' }"
                                                    color="{ path: 'priority', formatter: '.formatter.priorityColor' }"/>
                                            </HBox>
                                            <Text id="_IDGenText24" text="{category}" class="sapUiTinyMarginBottom" wrapping="false" maxLines="1" tooltip="{category}"/>
                                            <ObjectNumber id="_IDGenObjectNumber6" number="{impactAmount}" class="sapUiTinyMarginBottom"/>
                                            <HBox id="_IDGenHBox5" justifyContent="SpaceBetween">
                                                <Text id="_IDGenText25" text="{slaRemainingHours}h left"/>
                                                <Text id="_IDGenText26" text="{assignee/firstName}" wrapping="false" maxLines="1" tooltip="{assignee/firstName}"/>
                                            </HBox>
                                        </VBox>
                                    </CustomListItem>

                                </List>
                            </VBox>

                            <!-- Need Info -->
                            <VBox id="_IDGenVBox9" class="kanbanColumn sapUiSmallMarginEnd">
                                <Toolbar id="_IDGenToolbar2">
                                    <Title id="_IDGenTitle3" text="Need Info" level="H3"/>
                                    <ToolbarSpacer id="_IDGenToolbarSpacer4"/>
                                    <Label id="_IDGenLabel4" text="{viewModel>/kanban/needInfo}"/>
                                </Toolbar>

                                <List id="_IDGenList2"
                                    items="{
                                        path: '/DisputeCases',
                                        filters: [{
                                            path: 'status',
                                            operator: 'EQ',
                                            value1: 'NEED_INFO'
                                        }]
                                    }">

                                    <CustomListItem id="_IDGenCustomListItem2" press="onCasePress">
                                        <VBox id="_IDGenVBox10" class="kanbanCard">
                                            <HBox id="_IDGenHBox6" justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                                <Text id="_IDGenText27" text="{caseID}"/>
                                                <core:Icon id="_IDGenIcon2"
                                                    src="{ path: 'priority', formatter: '.formatter.priorityIcon' }"
                                                    color="{ path: 'priority', formatter: '.formatter.priorityColor' }"/>
                                            </HBox>
                                            <Text id="_IDGenText28" text="{category}" class="sapUiTinyMarginBottom" wrapping="false" maxLines="1" tooltip="{category}"/>
                                            <ObjectNumber id="_IDGenObjectNumber7" number="{impactAmount}" class="sapUiTinyMarginBottom"/>
                                            <HBox id="_IDGenHBox7" justifyContent="SpaceBetween">
                                                <Text id="_IDGenText29" text="Waiting"/>
                                                <Text id="_IDGenText30" text="{submitter/firstName}" wrapping="false" maxLines="1" tooltip="{submitter/firstName}"/>
                                            </HBox>
                                        </VBox>
                                    </CustomListItem>

                                </List>
                            </VBox>

                            <!-- Ready to Close -->
                            <VBox id="_IDGenVBox11" class="kanbanColumn">
                                <Toolbar id="_IDGenToolbar3">
                                    <Title id="_IDGenTitle4" text="Ready to Close" level="H3"/>
                                    <ToolbarSpacer id="_IDGenToolbarSpacer5"/>
                                    <Label id="_IDGenLabel5" text="{viewModel>/kanban/readyToClose}"/>
                                </Toolbar>

                                <List id="_IDGenList3"
                                    items="{
                                        path: '/DisputeCases',
                                        filters: [{
                                            path: 'status',
                                            operator: 'EQ',
                                            value1: 'READY_TO_CLOSE'
                                        }]
                                    }">

                                    <CustomListItem id="_IDGenCustomListItem3" press="onCasePress">
                                        <VBox id="_IDGenVBox12" class="kanbanCard">
                                            <HBox id="_IDGenHBox8" justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                                <Text id="_IDGenText31" text="{caseID}"/>
                                                <core:Icon id="_IDGenIcon3" src="sap-icon://message-success" color="#107E3E"/>
                                            </HBox>
                                            <Text id="_IDGenText32" text="{category}" class="sapUiTinyMarginBottom" wrapping="false" maxLines="1" tooltip="{category}"/>
                                            <ObjectNumber id="_IDGenObjectNumber8" number="{impactAmount}" class="sapUiTinyMarginBottom"/>
                                            <HBox id="_IDGenHBox9" justifyContent="SpaceBetween">
                                                <Text id="_IDGenText33" text="Resolved"/>
                                                <Text id="_IDGenText34" text="{assignee/firstName}" wrapping="false" maxLines="1" tooltip="{assignee/firstName}"/>
                                            </HBox>
                                        </VBox>
                                    </CustomListItem>

                                </List>
                            </VBox>

                        </HBox>
                    </ScrollContainer>

                </content>
            </IconTabBar>
        </f:content>
    </f:DynamicPage>
</mvc:View>